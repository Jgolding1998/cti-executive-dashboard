<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTI Gas - Executive Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e3a5f;
            --secondary: #3d5a80;
            --accent: #ee6c4d;
            --success: #06d6a0;
            --warning: #ffd166;
            --danger: #ef476f;
            --bg-dark: #0d1b2a;
            --bg-card: #1b2838;
            --text-primary: #ffffff;
            --text-secondary: #98c1d9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 24px; font-weight: 300; }
        .header h1 span { font-weight: 700; color: var(--accent); }
        .header .nav { display: flex; gap: 15px; flex-wrap: wrap; }
        .header .nav a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .header .nav a:hover, .header .nav a.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .timestamp { color: var(--text-secondary); font-size: 12px; }
        .page { display: none; padding: 25px; max-width: 1900px; margin: 0 auto; }
        .page.active { display: block; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .card.span-2 { grid-column: span 2; }
        .card.span-3 { grid-column: span 3; }
        .card.span-4 { grid-column: span 4; }
        .card-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-title::before {
            content: '';
            width: 3px;
            height: 16px;
            background: var(--accent);
            border-radius: 2px;
        }
        .metric {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .metric.green { background: linear-gradient(135deg, var(--success), #00ff88); -webkit-background-clip: text; background-clip: text; }
        .metric.small { font-size: 26px; }
        .metric-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        
        /* Clickable items */
        .clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        .clickable:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(238,108,77,0.3);
        }
        
        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .kpi-card {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .kpi-value { font-size: 28px; font-weight: 700; }
        .kpi-label { font-size: 11px; color: var(--text-secondary); margin-top: 5px; text-transform: uppercase; }
        .kpi-sub { font-size: 10px; color: var(--text-secondary); margin-top: 3px; }
        
        /* Breakdown */
        .breakdown { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .breakdown-item {
            text-align: center;
            padding: 12px 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        .breakdown-value { font-size: 18px; font-weight: 600; }
        .breakdown-label { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }
        
        /* Customer/Product lists */
        .list-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .list-name { font-size: 13px; }
        .list-value { font-size: 13px; font-weight: 600; color: var(--success); }
        
        /* AR Aging */
        .ar-bucket {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .ar-bucket.current { background: rgba(6,214,160,0.15); border-left: 4px solid var(--success); }
        .ar-bucket.warning { background: rgba(255,209,102,0.15); border-left: 4px solid var(--warning); }
        .ar-bucket.danger { background: rgba(239,71,111,0.15); border-left: 4px solid var(--danger); }
        
        /* Charts */
        .chart-container { position: relative; height: 250px; }
        
        /* Cash Flow */
        .cf-week {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            align-items: center;
        }
        .cf-week:hover { background: rgba(255,255,255,0.05); }
        .cf-week-name { font-weight: 600; }
        .cf-actual { color: var(--success); }
        .cf-predicted { color: var(--warning); }
        .cf-total { font-weight: 700; }
        
        /* Drill-down Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-header {
            padding: 20px 25px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 18px; font-weight: 500; }
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            opacity: 0.7;
        }
        .modal-close:hover { opacity: 1; }
        .modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(85vh - 80px);
        }
        .modal-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .modal-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        .modal-stat-value { font-size: 24px; font-weight: 700; }
        .modal-stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 5px; }
        
        /* Invoice Table */
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .invoice-table th {
            text-align: left;
            padding: 12px 8px;
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            position: sticky;
            top: 0;
        }
        .invoice-table td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .invoice-table tr:hover td { background: rgba(255,255,255,0.03); }
        .invoice-num { color: var(--accent); font-weight: 500; }
        .amount { text-align: right; font-weight: 600; }
        .amount.positive { color: var(--success); }
        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }
        .category-badge.product { background: rgba(78,205,196,0.2); color: #4ecdc4; }
        .category-badge.service { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .category-badge.freight { background: rgba(254,202,87,0.2); color: #feca57; }
        .category-badge.misc { background: rgba(162,155,254,0.2); color: #a29bfe; }
        
        @media (max-width: 768px) {
            .breakdown { grid-template-columns: repeat(2, 1fr); }
            .card.span-2, .card.span-3, .card.span-4 { grid-column: span 1; }
            .cf-week { grid-template-columns: 1fr 1fr; gap: 5px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1><span>CTI</span> Executive Dashboard</h1>
        <nav class="nav">
            <a class="active" onclick="showPage('overview')">Overview</a>
            <a onclick="showPage('sales')">Sales Detail</a>
            <a onclick="showPage('ar')">AR Aging</a>
            <a onclick="showPage('cashflow')">Cash Flow</a>
        </nav>
        <div class="timestamp" id="timestamp">Loading...</div>
    </header>
    
    <!-- Overview Page -->
    <div class="page active" id="page-overview">
        <div class="dashboard">
            <!-- Yesterday -->
            <div class="card clickable" onclick="drilldown('yesterday')">
                <div class="card-title">Yesterday's Sales</div>
                <div class="metric green" id="yesterdayTotal">$0</div>
                <div class="metric-label" id="yesterdayDate">Loading...</div>
                <div class="breakdown">
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('yesterday', 'Product')">
                        <div class="breakdown-value" style="color:#4ecdc4" id="yesterdayProduct">$0</div>
                        <div class="breakdown-label">Product</div>
                    </div>
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('yesterday', 'Service')">
                        <div class="breakdown-value" style="color:#ff6b6b" id="yesterdayService">$0</div>
                        <div class="breakdown-label">Service</div>
                    </div>
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('yesterday', 'Freight')">
                        <div class="breakdown-value" style="color:#feca57" id="yesterdayFreight">$0</div>
                        <div class="breakdown-label">Freight</div>
                    </div>
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('yesterday', 'Miscellaneous')">
                        <div class="breakdown-value" style="color:#a29bfe" id="yesterdayMisc">$0</div>
                        <div class="breakdown-label">Misc</div>
                    </div>
                </div>
            </div>
            
            <!-- MTD -->
            <div class="card clickable" onclick="drilldown('mtd')">
                <div class="card-title">Month to Date</div>
                <div class="metric" id="mtdTotal">$0</div>
                <div class="metric-label" id="mtdDays">0 business days</div>
                <div class="breakdown">
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('mtd', 'Product')">
                        <div class="breakdown-value" style="color:#4ecdc4" id="mtdProduct">$0</div>
                        <div class="breakdown-label">Product</div>
                    </div>
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('mtd', 'Service')">
                        <div class="breakdown-value" style="color:#ff6b6b" id="mtdService">$0</div>
                        <div class="breakdown-label">Service</div>
                    </div>
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('mtd', 'Freight')">
                        <div class="breakdown-value" style="color:#feca57" id="mtdFreight">$0</div>
                        <div class="breakdown-label">Freight</div>
                    </div>
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('mtd', 'Miscellaneous')">
                        <div class="breakdown-value" style="color:#a29bfe" id="mtdMisc">$0</div>
                        <div class="breakdown-label">Misc</div>
                    </div>
                </div>
            </div>
            
            <!-- YTD -->
            <div class="card clickable" onclick="drilldown('ytd')">
                <div class="card-title">Year to Date</div>
                <div class="metric" id="ytdTotal">$0</div>
                <div class="metric-label" id="ytdDays">0 business days</div>
                <div class="breakdown">
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('ytd', 'Product')">
                        <div class="breakdown-value" style="color:#4ecdc4" id="ytdProduct">$0</div>
                        <div class="breakdown-label">Product</div>
                    </div>
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('ytd', 'Service')">
                        <div class="breakdown-value" style="color:#ff6b6b" id="ytdService">$0</div>
                        <div class="breakdown-label">Service</div>
                    </div>
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('ytd', 'Freight')">
                        <div class="breakdown-value" style="color:#feca57" id="ytdFreight">$0</div>
                        <div class="breakdown-label">Freight</div>
                    </div>
                    <div class="breakdown-item clickable" onclick="event.stopPropagation(); drilldown('ytd', 'Miscellaneous')">
                        <div class="breakdown-value" style="color:#a29bfe" id="ytdMisc">$0</div>
                        <div class="breakdown-label">Misc</div>
                    </div>
                </div>
            </div>
            
            <!-- Daily Average -->
            <div class="card">
                <div class="card-title">Daily Averages</div>
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-value" style="color:var(--success)" id="mtdAvg">$0</div>
                        <div class="kpi-label">MTD Daily Avg</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="ytdAvg">$0</div>
                        <div class="kpi-label">YTD Daily Avg</div>
                    </div>
                </div>
            </div>
            
            <!-- AR Summary -->
            <div class="card clickable" onclick="showPage('ar')">
                <div class="card-title">Accounts Receivable</div>
                <div class="metric" id="arTotal">$0</div>
                <div class="metric-label">Total Outstanding</div>
                <div style="margin-top:15px">
                    <div class="ar-bucket current clickable" onclick="event.stopPropagation(); drilldownAR('Current')">
                        <span>Current</span>
                        <span id="arCurrent">$0</span>
                    </div>
                    <div class="ar-bucket warning clickable" onclick="event.stopPropagation(); drilldownAR('Days1_30')">
                        <span>1-30 Days</span>
                        <span id="ar1_30">$0</span>
                    </div>
                    <div class="ar-bucket danger clickable" onclick="event.stopPropagation(); drilldownAR('Days90Plus')">
                        <span>90+ Days</span>
                        <span id="ar90plus">$0</span>
                    </div>
                </div>
            </div>
            
            <!-- Top Customers Yesterday -->
            <div class="card">
                <div class="card-title">Top Customers Yesterday</div>
                <div id="topCustomersYesterday" style="max-height:300px;overflow-y:auto"></div>
            </div>
            
            <!-- Top Customers MTD -->
            <div class="card">
                <div class="card-title">Top Customers MTD</div>
                <div id="topCustomersMTD" style="max-height:300px;overflow-y:auto"></div>
            </div>
            
            <!-- Daily Trend Chart -->
            <div class="card span-2">
                <div class="card-title">Daily Sales Trend (Click bars for details)</div>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
            
            <!-- Cash Flow Preview -->
            <div class="card span-2 clickable" onclick="showPage('cashflow')">
                <div class="card-title">6-Week Cash Flow Forecast</div>
                <div id="cashflowPreview"></div>
            </div>
        </div>
    </div>
    
    <!-- Sales Detail Page -->
    <div class="page" id="page-sales">
        <div class="dashboard">
            <div class="card span-4">
                <div class="card-title">Top Products MTD (Click for details)</div>
                <div id="topProducts" style="max-height:500px;overflow-y:auto"></div>
            </div>
        </div>
    </div>
    
    <!-- AR Aging Page -->
    <div class="page" id="page-ar">
        <div class="dashboard">
            <div class="card">
                <div class="card-title">Current (Not Yet Due)</div>
                <div class="metric green" id="arCurrentDetail">$0</div>
                <div class="metric-label" id="arCurrentCount">0 invoices</div>
                <button onclick="drilldownAR('Current')" style="margin-top:15px;padding:10px 20px;background:var(--success);border:none;border-radius:8px;color:white;cursor:pointer">View Invoices</button>
            </div>
            <div class="card">
                <div class="card-title">1-30 Days Overdue</div>
                <div class="metric" style="color:var(--warning)" id="ar1_30Detail">$0</div>
                <div class="metric-label" id="ar1_30Count">0 invoices</div>
                <button onclick="drilldownAR('Days1_30')" style="margin-top:15px;padding:10px 20px;background:var(--warning);border:none;border-radius:8px;color:#333;cursor:pointer">View Invoices</button>
            </div>
            <div class="card">
                <div class="card-title">31-60 Days Overdue</div>
                <div class="metric" style="color:var(--accent)" id="ar31_60Detail">$0</div>
                <div class="metric-label" id="ar31_60Count">0 invoices</div>
                <button onclick="drilldownAR('Days31_60')" style="margin-top:15px;padding:10px 20px;background:var(--accent);border:none;border-radius:8px;color:white;cursor:pointer">View Invoices</button>
            </div>
            <div class="card">
                <div class="card-title">61-90 Days Overdue</div>
                <div class="metric" style="color:#ff6b6b" id="ar61_90Detail">$0</div>
                <div class="metric-label" id="ar61_90Count">0 invoices</div>
                <button onclick="drilldownAR('Days61_90')" style="margin-top:15px;padding:10px 20px;background:#ff6b6b;border:none;border-radius:8px;color:white;cursor:pointer">View Invoices</button>
            </div>
            <div class="card">
                <div class="card-title">90+ Days Overdue</div>
                <div class="metric" style="color:var(--danger)" id="ar90plusDetail">$0</div>
                <div class="metric-label" id="ar90plusCount">0 invoices</div>
                <button onclick="drilldownAR('Days90Plus')" style="margin-top:15px;padding:10px 20px;background:var(--danger);border:none;border-radius:8px;color:white;cursor:pointer">View Invoices</button>
            </div>
        </div>
    </div>
    
    <!-- Cash Flow Page -->
    <div class="page" id="page-cashflow">
        <div class="dashboard">
            <div class="card span-4">
                <div class="card-title">6-Week Cash Flow Forecast (Click any row for day-by-day breakdown)</div>
                <div id="cashflowDetail"></div>
            </div>
        </div>
    </div>
    
    <!-- Drill-down Modal -->
    <div class="modal-overlay" id="modal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
    
    <script>
        let DATA = null;
        let dailyChart = null;
        
        const fmt = (n) => '$' + (n || 0).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        const fmtK = (n) => '$' + ((n || 0) / 1000).toFixed(0) + 'K';
        
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            event.target.classList.add('active');
        }
        
        function loadData() {
            if (!DATA) return;
            
            // Timestamp
            document.getElementById('timestamp').textContent = `Data as of: ${DATA.LatestDataDate || DATA.GeneratedAt}`;
            
            // Yesterday
            const y = DATA.Summary.Yesterday;
            document.getElementById('yesterdayTotal').textContent = fmt(y.Total);
            document.getElementById('yesterdayDate').textContent = DATA.Period.Yesterday;
            document.getElementById('yesterdayProduct').textContent = fmt(y.Product);
            document.getElementById('yesterdayService').textContent = fmt(y.Service);
            document.getElementById('yesterdayFreight').textContent = fmt(y.Freight);
            document.getElementById('yesterdayMisc').textContent = fmt(y.Miscellaneous);
            
            // MTD
            const m = DATA.Summary.MTD;
            document.getElementById('mtdTotal').textContent = fmt(m.Total);
            document.getElementById('mtdDays').textContent = `${DATA.Period.MTDBusinessDays} business days`;
            document.getElementById('mtdProduct').textContent = fmt(m.Product);
            document.getElementById('mtdService').textContent = fmt(m.Service);
            document.getElementById('mtdFreight').textContent = fmt(m.Freight);
            document.getElementById('mtdMisc').textContent = fmt(m.Miscellaneous);
            
            // YTD
            const yt = DATA.Summary.YTD;
            document.getElementById('ytdTotal').textContent = fmt(yt.Total);
            document.getElementById('ytdDays').textContent = `${DATA.Period.YTDBusinessDays} business days`;
            document.getElementById('ytdProduct').textContent = fmt(yt.Product);
            document.getElementById('ytdService').textContent = fmt(yt.Service);
            document.getElementById('ytdFreight').textContent = fmt(yt.Freight);
            document.getElementById('ytdMisc').textContent = fmt(yt.Miscellaneous);
            
            // Averages
            document.getElementById('mtdAvg').textContent = fmt(DATA.Summary.MTDDailyAverage);
            document.getElementById('ytdAvg').textContent = fmt(DATA.Summary.YTDDailyAverage);
            
            // AR Summary
            const ar = DATA.ARaging;
            document.getElementById('arTotal').textContent = fmt(ar.Total);
            document.getElementById('arCurrent').textContent = fmt(ar.Current);
            document.getElementById('ar1_30').textContent = fmt(ar.Days1_30);
            document.getElementById('ar90plus').textContent = fmt(ar.Days90Plus);
            
            // AR Detail Page
            document.getElementById('arCurrentDetail').textContent = fmt(ar.Current);
            document.getElementById('arCurrentCount').textContent = `${DATA.ARInvoices?.Current?.length || 0} invoices`;
            document.getElementById('ar1_30Detail').textContent = fmt(ar.Days1_30);
            document.getElementById('ar1_30Count').textContent = `${DATA.ARInvoices?.Days1_30?.length || 0} invoices`;
            document.getElementById('ar31_60Detail').textContent = fmt(ar.Days31_60);
            document.getElementById('ar31_60Count').textContent = `${DATA.ARInvoices?.Days31_60?.length || 0} invoices`;
            document.getElementById('ar61_90Detail').textContent = fmt(ar.Days61_90);
            document.getElementById('ar61_90Count').textContent = `${DATA.ARInvoices?.Days61_90?.length || 0} invoices`;
            document.getElementById('ar90plusDetail').textContent = fmt(ar.Days90Plus);
            document.getElementById('ar90plusCount').textContent = `${DATA.ARInvoices?.Days90Plus?.length || 0} invoices`;
            
            // Top Customers Yesterday
            const custYesterday = DATA.TopCustomers?.Yesterday || [];
            document.getElementById('topCustomersYesterday').innerHTML = custYesterday.length === 0 
                ? '<div style="color:var(--text-secondary);padding:20px;text-align:center">No sales data for yesterday</div>'
                : custYesterday.map(c => `
                    <div class="list-item clickable" onclick="drilldownCustomer('${c.Name.replace(/'/g, "\\'")}', 'yesterday')">
                        <span class="list-name">${c.Name}</span>
                        <span class="list-value">${fmt(c.Amount)}</span>
                    </div>
                `).join('');
            
            // Top Customers MTD
            const custMTD = DATA.TopCustomers?.MTD || [];
            document.getElementById('topCustomersMTD').innerHTML = custMTD.map(c => `
                <div class="list-item clickable" onclick="drilldownCustomer('${c.Name.replace(/'/g, "\\'")}', 'mtd')">
                    <span class="list-name">${c.Name}</span>
                    <span class="list-value">${fmt(c.Amount)}</span>
                </div>
            `).join('');
            
            // Top Products
            const prods = DATA.TopProducts?.MTD || [];
            document.getElementById('topProducts').innerHTML = `
                <table class="invoice-table">
                    <thead><tr><th>Item</th><th>Description</th><th>Category</th><th style="text-align:right">MTD Sales</th></tr></thead>
                    <tbody>
                        ${prods.map(p => `
                            <tr class="clickable">
                                <td class="invoice-num">${p.Item}</td>
                                <td>${p.Description || '-'}</td>
                                <td><span class="category-badge ${(p.Category || 'product').toLowerCase()}">${p.Category || 'Product'}</span></td>
                                <td class="amount positive">${fmt(p.Amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            // Cash Flow Preview
            const cf = DATA.CashFlowPrediction || [];
            document.getElementById('cashflowPreview').innerHTML = cf.map(w => `
                <div class="cf-week clickable" onclick="drilldownWeek(${w.WeekNum - 1})">
                    <span class="cf-week-name">${w.Week}</span>
                    <span class="cf-actual">Actual: ${fmt(w.Actual)}</span>
                    <span class="cf-predicted">Predicted: ${fmt(w.Predicted)}</span>
                    <span class="cf-total">${fmt(w.Total)}</span>
                </div>
            `).join('');
            
            // Cash Flow Detail
            document.getElementById('cashflowDetail').innerHTML = cf.map(w => `
                <div class="cf-week clickable" onclick="drilldownWeek(${w.WeekNum - 1})" style="border-bottom:2px solid rgba(255,255,255,0.1);padding:15px 12px;">
                    <span class="cf-week-name">${w.Week} <span style="color:var(--text-secondary);font-size:12px">(${w.Confidence}% confidence)</span></span>
                    <span class="cf-actual">Actual: ${fmt(w.Actual)}</span>
                    <span class="cf-predicted">Predicted: ${fmt(w.Predicted)}</span>
                    <span class="cf-total" style="font-size:18px">${fmt(w.Total)}</span>
                </div>
            `).join('');
            
            // Daily Chart
            renderDailyChart();
        }
        
        function renderDailyChart() {
            const trend = DATA.DailyTrend?.slice(-20) || [];
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            if (dailyChart) dailyChart.destroy();
            
            dailyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: trend.map(d => d.Date.slice(5)),
                    datasets: [
                        { label: 'Product', data: trend.map(d => d.Product), backgroundColor: '#4ecdc4', stack: 'stack' },
                        { label: 'Service', data: trend.map(d => d.Service), backgroundColor: '#ff6b6b', stack: 'stack' },
                        { label: 'Freight', data: trend.map(d => d.Freight), backgroundColor: '#feca57', stack: 'stack' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const dateKey = trend[idx].Date;
                            drilldownDate(dateKey);
                        }
                    },
                    plugins: { legend: { labels: { color: '#98c1d9' } } },
                    scales: {
                        x: { stacked: true, ticks: { color: '#98c1d9' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { stacked: true, ticks: { color: '#98c1d9', callback: v => fmtK(v) }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }
        
        // DRILL-DOWN FUNCTIONS
        function drilldown(period, category = null) {
            const data = period === 'yesterday' ? DATA.Summary.Yesterday :
                         period === 'mtd' ? DATA.Summary.MTD : DATA.Summary.YTD;
            
            let invoices = data.Invoices || [];
            let title = period === 'yesterday' ? `Yesterday (${DATA.Period.Yesterday})` :
                        period === 'mtd' ? 'Month to Date' : 'Year to Date';
            
            if (category) {
                invoices = invoices.filter(inv => inv.Category === category);
                title += ` - ${category}`;
            }
            
            const total = invoices.reduce((sum, inv) => sum + inv.Amount, 0);
            
            showModal(title, `
                <div class="modal-summary">
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color:var(--success)">${fmt(total)}</div>
                        <div class="modal-stat-label">Total</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${invoices.length}</div>
                        <div class="modal-stat-label">Invoices</div>
                    </div>
                    ${!category ? `
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color:#4ecdc4">${fmt(data.Product)}</div>
                        <div class="modal-stat-label">Product</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color:#ff6b6b">${fmt(data.Service)}</div>
                        <div class="modal-stat-label">Service</div>
                    </div>
                    ` : ''}
                </div>
                ${renderInvoiceTable(invoices)}
            `);
        }
        
        function drilldownDate(dateKey) {
            const invoices = DATA.InvoicesByDate?.[dateKey] || [];
            const dayData = DATA.DailyTrend?.find(d => d.Date === dateKey);
            
            showModal(`Sales on ${dateKey}`, `
                <div class="modal-summary">
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color:var(--success)">${fmt(dayData?.Total || 0)}</div>
                        <div class="modal-stat-label">Total</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${invoices.length}</div>
                        <div class="modal-stat-label">Invoices</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color:#4ecdc4">${fmt(dayData?.Product || 0)}</div>
                        <div class="modal-stat-label">Product</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color:#ff6b6b">${fmt(dayData?.Service || 0)}</div>
                        <div class="modal-stat-label">Service</div>
                    </div>
                </div>
                ${renderInvoiceTable(invoices)}
            `);
        }
        
        function drilldownAR(bucket) {
            const invoices = DATA.ARInvoices?.[bucket] || [];
            const total = invoices.reduce((sum, inv) => sum + inv.Amount, 0);
            const bucketNames = {
                'Current': 'Current (Not Yet Due)',
                'Days1_30': '1-30 Days Overdue',
                'Days31_60': '31-60 Days Overdue',
                'Days61_90': '61-90 Days Overdue',
                'Days90Plus': '90+ Days Overdue'
            };
            
            showModal(`AR Aging: ${bucketNames[bucket]}`, `
                <div class="modal-summary">
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color:var(--danger)">${fmt(total)}</div>
                        <div class="modal-stat-label">Total Outstanding</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${invoices.length}</div>
                        <div class="modal-stat-label">Invoices</div>
                    </div>
                </div>
                <table class="invoice-table">
                    <thead><tr><th>Invoice</th><th>Customer</th><th>Due Date</th><th>Days Over</th><th style="text-align:right">Amount</th></tr></thead>
                    <tbody>
                        ${invoices.slice(0, 100).map(inv => `
                            <tr>
                                <td class="invoice-num">${inv.InvNum}</td>
                                <td>${inv.Customer || '-'}</td>
                                <td>${inv.DueDate || '-'}</td>
                                <td style="color:${inv.DaysOverdue > 60 ? 'var(--danger)' : inv.DaysOverdue > 30 ? 'var(--warning)' : 'inherit'}">${inv.DaysOverdue}</td>
                                <td class="amount positive">${fmt(inv.Amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${invoices.length > 100 ? `<p style="color:var(--text-secondary);margin-top:15px">Showing 100 of ${invoices.length} invoices</p>` : ''}
            `);
        }
        
        function drilldownCustomer(name, period) {
            const custData = period === 'yesterday' 
                ? DATA.TopCustomers?.Yesterday?.find(c => c.Name === name)
                : DATA.TopCustomers?.MTD?.find(c => c.Name === name);
            
            const invoices = custData?.Invoices || [];
            
            showModal(`${name} - ${period === 'yesterday' ? 'Yesterday' : 'MTD'}`, `
                <div class="modal-summary">
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color:var(--success)">${fmt(custData?.Amount || 0)}</div>
                        <div class="modal-stat-label">Total</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${invoices.length}</div>
                        <div class="modal-stat-label">Invoices</div>
                    </div>
                </div>
                <table class="invoice-table">
                    <thead><tr><th>Invoice</th><th>Date</th><th>Order</th><th style="text-align:right">Amount</th></tr></thead>
                    <tbody>
                        ${invoices.map(inv => `
                            <tr>
                                <td class="invoice-num">${inv.InvNum}</td>
                                <td>${inv.Date || '-'}</td>
                                <td>${inv.CoNum || '-'}</td>
                                <td class="amount positive">${fmt(inv.Amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `);
        }
        
        function drilldownWeek(weekIdx) {
            const week = DATA.CashFlowPrediction?.[weekIdx];
            if (!week) return;
            
            showModal(`${week.Week} - Day by Day Breakdown`, `
                <div class="modal-summary">
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color:var(--success)">${fmt(week.Actual)}</div>
                        <div class="modal-stat-label">Actual</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color:var(--warning)">${fmt(week.Predicted)}</div>
                        <div class="modal-stat-label">Predicted</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${fmt(week.Total)}</div>
                        <div class="modal-stat-label">Total</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${week.Confidence}%</div>
                        <div class="modal-stat-label">Confidence</div>
                    </div>
                </div>
                <table class="invoice-table">
                    <thead><tr><th>Date</th><th>Day</th><th>Type</th><th style="text-align:right">Amount</th><th>Invoices</th></tr></thead>
                    <tbody>
                        ${(week.DayBreakdown || []).map(day => `
                            <tr class="${day.Type === 'Actual' ? 'clickable' : ''}" ${day.Type === 'Actual' ? `onclick="drilldownDate('${day.Date}')"` : ''}>
                                <td>${day.Date}</td>
                                <td>${day.DayOfWeek}</td>
                                <td><span class="category-badge ${day.Type === 'Actual' ? 'product' : 'service'}">${day.Type}</span></td>
                                <td class="amount ${day.Type === 'Actual' ? 'positive' : ''}">${fmt(day.Amount)}</td>
                                <td>${day.Invoices?.length || (day.Type === 'Predicted' ? '-' : '0')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `);
        }
        
        function renderInvoiceTable(invoices) {
            if (!invoices || invoices.length === 0) {
                return '<p style="color:var(--text-secondary);text-align:center;padding:20px">No invoices found</p>';
            }
            return `
                <table class="invoice-table">
                    <thead><tr><th>Invoice</th><th>Customer</th><th>Date</th><th>Category</th><th style="text-align:right">Amount</th></tr></thead>
                    <tbody>
                        ${invoices.slice(0, 200).map(inv => `
                            <tr>
                                <td class="invoice-num">${inv.InvNum}</td>
                                <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${inv.Customer || '-'}</td>
                                <td>${inv.Date || '-'}</td>
                                <td><span class="category-badge ${(inv.Category || 'product').toLowerCase()}">${inv.Category || 'Product'}</span></td>
                                <td class="amount positive">${fmt(inv.Amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${invoices.length > 200 ? `<p style="color:var(--text-secondary);margin-top:15px">Showing 200 of ${invoices.length} invoices</p>` : ''}
            `;
        }
        
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }
        
        function closeModal(e) {
            if (!e || e.target.classList.contains('modal-overlay')) {
                document.getElementById('modal').classList.remove('active');
            }
        }
        
        // Keyboard shortcut to close modal
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });
        
        // Load data when page loads
        loadData();
    </script>
</body>
</html>
